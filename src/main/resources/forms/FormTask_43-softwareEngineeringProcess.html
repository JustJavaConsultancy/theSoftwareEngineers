<form id="storiesForm"
      th:action="@{~/tasks/complete}"
      th:object="${stories}"
      method="post"
      hx-post="/tasks/complete"
      hx-target="#storiesForm"
      hx-swap="outerHTML"
      class="space-y-8 bg-gray-50 p-8 rounded-2xl shadow-md">
  <style>
    .text-whiter{color:white;}
  </style>
<!---->
  <input type="hidden" th:value="${id}" id="id" name="id">

  <!-- Total count -->
  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-2">Total Stories</label>
    <input type="number"
           th:value="*{total}"
           name="total"
           class="w-full px-4 py-2.5 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none"
           readonly>
  </div>

  <!-- Loop over user stories -->
  <div th:each="story, iterStat : *{user_stories}"
       class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 space-y-4">

    <!-- Header -->
    <div class="flex justify-between items-center border-b pb-3">
      <h2 class="text-lg font-bold text-gray-800"
          th:text="'User Story ' + ${story.id}"></h2>
      <button type="button"
              class="toggleEdit bg-blue-600 hover:bg-blue-700 text-whiter text-sm px-4 py-2 rounded-lg transition"
              th:attr="data-target=${'edit-' + iterStat.index}">
        Edit
      </button>
    </div>

    <!-- View Mode -->
    <div th:id="${'view-' + iterStat.index}" class="space-y-3">
      <p class="text-gray-700"><span class="font-medium">Story:</span> <span th:text="${story.story}"></span></p>
      <div>
        <p class="font-medium text-gray-700">Acceptance Criteria:</p>
        <ul class="list-disc list-inside text-gray-600 mt-1 space-y-1">
          <li th:each="criteria : ${story.acceptance_criteria}" th:text="${criteria}"></li>
        </ul>
      </div>
      <p class="text-gray-700"><span class="font-medium">Priority:</span> <span th:text="${story.priority}"></span></p>
    </div>

    <!-- Edit Mode -->
    <div th:id="${'edit-' + iterStat.index}" class="hidden space-y-5">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Story</label>
        <textarea th:field="*{user_stories[__${iterStat.index}__].story}"
                  rows="3"
                  class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Acceptance Criteria</label>
        <div th:each="criteria, ci : ${story.acceptance_criteria}" class="mb-2">
          <input type="text"
                 th:field="*{user_stories[__${iterStat.index}__].acceptance_criteria[__${ci.index}__]}"
                 class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
        <select th:field="*{user_stories[__${iterStat.index}__].priority}"
                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option>Must have</option>
          <option>Should have</option>
          <option>Could have</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Submit -->
  <button type="submit"
          style="background-color:#3b82f6"
          class="flex items-center justify-center w-full text-whiter font-medium py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
    <span class="material-icons mr-2">save</span>
    Save All Stories
  </button>
</form>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".toggleEdit").forEach(btn => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-target");
        const editSection = document.getElementById(targetId);
        const viewSection = document.getElementById(targetId.replace("edit-", "view-"));
        if (editSection.classList.contains("hidden")) {
          editSection.classList.remove("hidden");
          viewSection.classList.add("hidden");
          btn.textContent = "Cancel";
        } else {
          editSection.classList.add("hidden");
          viewSection.classList.remove("hidden");
          btn.textContent = "Edit";
        }
      });
    });
  });
</script>